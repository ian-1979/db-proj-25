{% extends 'include/layout.html' %}
{% block content %}

<div class="container mt-5">
  <h2>Edit Notecard</h2>

  <form method="POST" enctype="multipart/form-data">

    <!-- Base Fields -->
    <div class="mb-3">
      <label class="form-label">Name</label>
      <input type="text" class="form-control" name="name" value="{{ card.name }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Type</label>
      <select name="type" class="form-select" id="type" required>
        <option value="">-- Select a Type --</option>
        <option value="character" {% if card.type == 'character' %}selected{% endif %}>Character</option>
        <option value="monster" {% if card.type == 'monster' %}selected{% endif %}>Monster</option>
        <option value="npc" {% if card.type == 'npc' %}selected{% endif %}>NPC</option>
        <option value="location" {% if card.type == 'location' %}selected{% endif %}>Location</option>
        <option value="spell" {% if card.type == 'spell' %}selected{% endif %}>Spell</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="text" rows="4">{{ card.text }}</textarea>
    </div>

    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" name="public" id="public" value="1" {% if card.public %}checked{% endif %}>
      <label class="form-check-label" for="public">
        Make Public
      </label>
    </div>

    <!-- Image Upload -->
    <div class="mb-3">
      <label class="form-label">Upload New Image (optional)</label>
      <input class="form-control" type="file" name="image" accept="image/*">
      {% if card.note_image_path %}
      <p class="mt-2"><small>Current Image: <a href="{{ card.note_image_path }}" target="_blank">View</a></small></p>
      {% endif %}
    </div>

    <!-- Extra Fields Section -->
    <div id="extra-fields">
      
      <!-- Character Fields -->
      <div id="character-fields" class="extra-type" style="display:none;">
        <h5 class="mt-4">Character Details</h5>
        <div class="mb-3">
          <label class="form-label">Race</label>
          <input type="text" class="form-control" name="race" value="{{ extra.race }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Level</label>
          <input type="number" class="form-control" name="level" value="{{ extra.level }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Class (optional)</label>
          <input type="text" class="form-control" name="class" value="{{ extra.class }}">
        </div>
        {% include 'include/stats_fields.html' %}
      </div>

      <!-- Monster Fields -->
      <div id="monster-fields" class="extra-type" style="display:none;">
        <h5 class="mt-4">Monster Details</h5>
        <div class="mb-3">
          <label class="form-label">Challenge Rating (CR)</label>
          <input type="number" step="0.1" class="form-control" name="cr" value="{{ extra.level }}">
        </div>
        {% include 'include/stats_fields.html' %}
      </div>

      <!-- NPC Fields -->
      <div id="npc-fields" class="extra-type" style="display:none;">
        <h5 class="mt-4">NPC Details</h5>
        <div class="mb-3">
          <label class="form-label">Race</label>
          <input type="text" class="form-control" name="race" value="{{ extra.race }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Level (optional CR)</label>
          <input type="number" class="form-control" name="cr" value="{{ extra.level }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Class (optional)</label>
          <input type="text" class="form-control" name="class" value="{{ extra.class }}">
        </div>
        {% include 'include/stats_fields.html' %}
      </div>

      <!-- Spell Fields -->
      <div id="spell-fields" class="extra-type" style="display:none;">
        <h5 class="mt-4">Spell Details</h5>
        <div class="mb-3">
          <label class="form-label">Level</label>
          <input type="number" min="0" max="9" class="form-control" name="spell_level" value="{{ extra.spell_level }}">
        </div>
        <div class="mb-3">
          <label class="form-label">School</label>
          <input type="text" class="form-control" name="school" value="{{ extra.school }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Description Text</label>
          <textarea class="form-control" name="spell_description">{{ extra.spell_text }}</textarea>
        </div>
        <div class="mb-3">
          <label class="form-label">Damage Type (optional)</label>
          <input type="text" class="form-control" name="damage_type" value="{{ extra.damage_type }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Damage (optional)</label>
          <input type="text" class="form-control" name="damage" value="{{ extra.damage }}">
        </div>
        <div class="mb-3">
          <label class="form-label">Save (optional)</label>
          <input type="text" class="form-control" name="save" value="{{ extra.save }}">
        </div>
      </div>

      <!-- Location Fields -->
      <div id="location-fields" class="extra-type" style="display:none;">
        <h5 class="mt-4">Location Details</h5>
        <div class="mb-3">
          <label class="form-label">Location Type</label>
          <input type="text" class="form-control" name="location_type" value="{{ extra.location_type }}">
        </div>
      </div>

    </div>

    <button type="submit" class="btn btn-primary mt-4">Save Changes</button>
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      function updateFields() {
        var allFields = document.querySelectorAll('.extra-type');
        allFields.forEach(div => div.style.display = 'none');

        var selected = document.getElementById(document.getElementById('type').value.toLowerCase() + '-fields');
        if (selected) {
          selected.style.display = 'block';
        }
      }

      var typeSelect = document.getElementById('type');
      if (typeSelect) {
        typeSelect.addEventListener('change', updateFields);
        updateFields();  // Auto-run on load
      }
    });
  </script>

</div>

{% endblock %}
